<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Monthly Updates</title>
</head>
<body>
    <div id="monthly-updates-container"></div>

    <script>
        let users; // Declare users globally
        let books;

        async function getUsersAndBooksForMonthlyUpdates() {
            try {
                // Make an AJAX request to the PHP endpoint to fetch users and books
                const response = await fetch('weekly_updates.php?action=getUsersAndBooksForMonthlyUpdates');

                if (!response.ok) {
                    throw new Error('Failed to fetch users and books');
                }

                const data = await response.json();
                console.log('Data:', data);

                users = data.users; // Assign data.users to the global users variable
                books = data.books; // Assign data.books to the global books variable

                return data;
            } catch (error) {
                console.error('Error fetching users and books:', error);
                throw error;
            }
        }

        async function displayUsersAndBooks() {
            const container = document.getElementById('monthly-updates-container');
            container.innerHTML = '<p>Loading...</p>';

            try {
                const data = await getUsersAndBooksForMonthlyUpdates();
                console.log('Data:', data);

                console.log('Books:', books);
                console.log('Users:', users); // Check if users is defined

                let html = '';

                if (users.length === 0) {
                    container.innerHTML = '<p>No users available</p>';
                    return;
                }

                html += '<h2>Users with notifications enabled:</h2>';
                users.forEach(user => {
                    html += `<h3>${user.email}</h3>`;
                });

                if (books.length > 0) {
                    html += '<h2>Fetched Books:</h2>';
                    html += '<ul>';
                    books.forEach(book => {
                        html += `<li>${book.title} by ${book.authors.join(', ')} (${book.publishedDate})</li>`;
                    });
                    html += '</ul>';
                } else {
                    html += '<p>No books available</p>';
                }

                // Display a button to send email
                html += '<button onclick="sendEmail()">Send Email</button>'; // Call sendEmail function when clicked

                container.innerHTML = html;
            } catch (error) {
                console.error('Error fetching data:', error);
                container.innerHTML = `<p>Error fetching data: ${error.message}</p>`;
            }
        }

        async function sendEmail() {
            try {
                // Make an AJAX POST request to email.php with the users and books data
                const response = await fetch('email.php', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ email: users[0].email, books: books }) // Access the email directly from the users array
                });

                if (!response.ok) {
                    throw new Error('Failed to send email');
                }

                // Check the response from email.php
                const data = await response.json();
                console.log('Response from email.php:', data);
            } catch (error) {
                console.error('Error sending email:', error);
            }
        }

        window.addEventListener('DOMContentLoaded', displayUsersAndBooks);
    </script>
</body>
</html>
